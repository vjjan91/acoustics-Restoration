---
editor_options: 
  chunk_output_type: console
---

# Generalized linear mixed modeling (acoustic space use and vegetation data)

In this script, we run generalized linear models to test the association between acoustic space use values and restoration type. In addition, we run generalized linear mixed models to test associations between acoustic space use and habitat (vegetation structure) using site-pair name (actively restored and naturally regenerating were specified to be paired) and repeat visits as random effects.  

Install required libraries
```{r}
library(tidyverse)
library(dplyr)
library(stringr)
library(vegan)
library(ggplot2)
library(scico)
library(psych)
library(rcompanion)
library(multcomp)
library(lme4)
library(ggpubr)
library(sjPlot)

# Source any custom/other internal functions necessary for analysis
source("code/01_internal-functions.R")
```

Load necessary data for statistical modeling
```{r}
# load list of sites
sites <- read.csv("data/list-of-sites.csv") %>% 
  dplyr::select("Site.code","Restoration.type") %>%
  filter(Site.code != "OLCAP5B")

# load the entire asu data across all sites and days computed
sitebyDayAsu <- read.csv("data/site-by-day-asu.csv") 

# separate by Site and Date
sitebyDayAsu <- separate(sitebyDayAsu, col = Site_Day, into = c("Site", "Date"), sep = "_") 

# Add restoration type column to the space use data
sitebyDayAsu <- left_join(sitebyDayAsu, sites, by=c("Site"="Site.code"))

# scale values per site/date for comparison between sites and treatment types
sitebyDayAsu <- sitebyDayAsu %>%
  group_by(Site, Date, Restoration.type) %>%
  mutate(f.cont.scaled = range01(f.cont))

# computing total number of days for which space use has been computed for each site (some sites have very few days. Eg. OLV110R, else rest have 5 days of audio data each)
nSites_Days <- sitebyDayAsu %>%
  dplyr::select(Site, Date, Restoration.type) %>%
  distinct() %>%
  group_by(Site) %>%
  count()

# Let's look at data by restoration type
# This suggests that we have more data for benchmark sites relative to the other two treatment types
nDays_siteType <- sitebyDayAsu %>%
  dplyr::select(Site, Date, Restoration.type) %>%
  distinct() %>%
  group_by(Restoration.type) %>%
  count()
  
# Separate analysis: space use during certain times of day alone
# let's look only at dawn chorus to explore what the data looks like
dawn <- c("05:00-06:00","06:00-07:00","07:00-08:00","08:00-09:00",
          "09:00-10:00")
dawnChorusAsu <- sitebyDayAsu %>%
  filter(time_of_day %in% dawn)

# Separate analysis: space use during certain times of day alone
# let's look only at dusk chorus to explore what the data looks like
dusk <- c("16:00-17:00","17:00-18:00","18:00-19:00","19:00-20:00")
duskChorusAsu <- sitebyDayAsu %>%
  filter(time_of_day %in% dusk)

# Prepare data for statistical modeling
# Calculating total space use across all frequency bins and times of day: 128*24 for each site-day combination

totSpaceUse <- sitebyDayAsu %>%
  group_by(Site, Date, Restoration.type) %>%
  summarise(totSpaceuse = sum(f.cont.scaled)) %>%
  group_by(Site) %>% 
  mutate(visit = row_number()) %>%
  mutate(siteCode = str_extract(Site, pattern = "\\w+\\d+")) %>%
  mutate(siteCode = factor(siteCode))

# Calculating total space use for dawn chorus alone for each site-day combination

totSpaceUseDawn <- dawnChorusAsu %>%
  group_by(Site, Date, Restoration.type) %>%
  summarise(totSpaceuse = sum(f.cont.scaled)) %>% 
  group_by(Site) %>% 
  mutate(visit = row_number()) %>%
  mutate(siteCode = str_extract(Site, pattern = "\\w+\\d+")) %>%
  mutate(siteCode = factor(siteCode))

# Calculating total space use for dusk chorus alone for each site-date combination

totSpaceUseDusk <- duskChorusAsu %>%
  group_by(Site, Date, Restoration.type) %>%
  summarise(totSpaceuse = sum(f.cont.scaled)) %>% 
  group_by(Site) %>% 
  mutate(visit = row_number()) %>%
  mutate(siteCode = str_extract(Site, pattern = "\\w+\\d+")) %>%
  mutate(siteCode = factor(siteCode))

# Load data from previous scripts for use in a GLM
vegData <-  read.csv("data/summaryVeg.csv") %>%
  filter(!str_detect(Site_ID, 'OLCAP5B'))
vegPcaScores <- read.csv("data/pcaVeg.csv") %>%
  filter(!str_detect(Site_ID, 'OLCAP5B'))
```


Getting data ready in a format for linear modeling
```{r}
# overall space use
modelDataAll <- vegPcaScores %>% 
  rename(Site = Site_ID) %>%
  rename(Restoration.type = Site_type) %>%
  mutate(across(Restoration.type, factor))  %>%
  full_join(totSpaceUse, by=c("Site","Restoration.type")) %>%
  mutate("roundSpaceuse" = round(totSpaceuse))

# dawn chorus space use
modelDataDawn <- vegPcaScores %>% 
  rename(Site = Site_ID) %>%
  rename(Restoration.type = Site_type) %>%
  mutate(across(Restoration.type, factor))  %>%
  full_join(totSpaceUseDawn, by=c("Site","Restoration.type")) %>%
  mutate("roundSpaceuse" = round(totSpaceuse))

# dusk chorus space use
modelDataDusk <- vegPcaScores %>% 
  rename(Site = Site_ID) %>%
  rename(Restoration.type = Site_type) %>%
  mutate(across(Restoration.type, factor))  %>%
  full_join(totSpaceUseDusk, by=c("Site","Restoration.type")) %>%
  mutate("roundSpaceuse" = round(totSpaceuse))
```

Running the generalized linear mixed models

We now run generalized linear mixed models (GLMM) assuming gaussian errors and using log link functions to examine the effects of restoration type (benchmark, actively restored and passively restored) on acoustic space use, followed by TukeyHSD multiple comparisons tests of means. 

```{r}
# overall space use
glmm_allRestoration <- glmer(totSpaceuse ~ Restoration.type + (1|siteCode) + (1|visit), data = modelDataAll, family = gaussian(link="log"))

summary(glmm_allRestoration)
tukey_glmmAllRestoration <- summary(glht(glmm_allRestoration, linfct=mcp(Restoration.type ="Tukey")))
cld(tukey_glmmAllRestoration)

# The above result suggests a significant difference in acoustic space use values for benchmark sites and passively restored sites and benchmark sites and actively restored sites (but no difference between active-passive)

# dawn chorus
glmm_dawnRestoration <- glmer(totSpaceuse ~ Restoration.type + (1|siteCode) + (1|visit), data = modelDataDawn, family = gaussian(link="log"))

summary(glmm_dawnRestoration)
tukey_glmmdawnRestoration <- summary(glht(glmm_dawnRestoration, linfct=mcp(Restoration.type ="Tukey")))
cld(tukey_glmmdawnRestoration)

# When we look at only the dawn chorus data, the above result suggests a significant difference in acoustic space use values for benchmark sites and passively restored sites and actively restored sites and passively restored sites (but no difference between active-benchmark)

# dusk chorus
glmm_duskRestoration <- glmer(totSpaceuse ~ Restoration.type + (1|siteCode) + (1|visit), data = modelDataDusk, family = gaussian(link="log"))

summary(glmm_duskRestoration)
tukey_glmmduskRestoration <- summary(glht(glmm_duskRestoration, linfct=mcp(Restoration.type ="Tukey")))
cld(tukey_glmmduskRestoration)

# For dusk chorus data, the above result suggests a significant difference in acoustic space use values for benchmark sites and passively restored sites and benchmark sites and actively restored sites (but no difference between active-passive)

# Plotting the above results

mycolours <- c("#440154FF", "#21908CFF", "orange")

fig_glmm_allRest <- ggplot (totSpaceUse, aes(Restoration.type, totSpaceuse, group = Restoration.type, fill = Restoration.type)) + 
  geom_boxplot(alpha = 0.75) + 
  theme_bw() +
  scale_x_discrete(labels = c('AR','BM','NR')) +
  labs(x = "Restoration Type", 
       y="Overall acoustic space use") +
  scale_fill_manual(values = mycolours, name = "Restoration type", labels = c('AR','BM','NR')) +
  stat_summary(geom = 'text', label = c("a", "b", "a"), fun = max, vjust = -1, size = 5.0) +
  theme(axis.title = element_text(size = 14, face = "bold"), 
        axis.ticks.length.x = unit(.5, "cm"),
        axis.text = element_text(size = 12),
        legend.title = element_blank(),
        legend.key.size = unit(1,"cm"),
        legend.text = element_text(size = 12))
  
ggsave(fig_glmm_allRest, filename = "figs/fig_glmm_overallAcousticSpace.png", width=12, height=7, device = png(), units="in", dpi = 300);dev.off()

fig_glmm_dawnRest <- ggplot(totSpaceUseDawn, aes(Restoration.type, totSpaceuse, group = Restoration.type, fill = Restoration.type)) + 
  geom_boxplot(alpha = 0.75) + 
  theme_bw() +
  scale_x_discrete(labels = c('AR','BM','NR')) +
  labs(x = "Restoration Type", 
       y="Dawn acoustic space use") +
  scale_fill_manual(values = mycolours, name = "Restoration type", labels = c('AR','BM','NR')) +
  stat_summary(geom = 'text', label = c("b", "b", "a"), fun = max, vjust = -1, size = 5.0) +
  theme(axis.title = element_text(size = 14, face = "bold"), 
        axis.ticks.length.x = unit(.5, "cm"),
        axis.text = element_text(size = 12),
        legend.title = element_blank(),
        legend.key.size = unit(1,"cm"),
        legend.text = element_text(size = 12))
  
ggsave(fig_glmm_dawnRest, filename = "figs/fig_glmm_dawnAcousticSpaceUse.png", width=12, height=7, device = png(), units="in", dpi = 300);dev.off()

fig_glmm_duskRest <- ggplot(totSpaceUseDusk, aes(Restoration.type, totSpaceuse, group = Restoration.type, fill = Restoration.type)) + 
  geom_boxplot(alpha = 0.75) + 
  theme_bw() +
  scale_x_discrete(labels = c('AR','BM','NR')) +
  labs(x = "Restoration Type", 
       y="Dusk acoustic space use") +
  scale_fill_manual(values = mycolours, name = "Restoration type", labels = c('AR','BM','NR')) +
  stat_summary(geom = 'text', label = c("a", "b", "a"), fun = max, vjust = -1, size = 5.0) +
  theme(axis.title = element_text(size = 14, face = "bold"), 
        axis.ticks.length.x = unit(.5, "cm"),
        axis.text = element_text(size = 12),
        legend.title = element_blank(),
        legend.key.size = unit(1,"cm"),
        legend.text = element_text(size = 12))
  
ggsave(fig_glmm_duskRest, filename = "figs/fig_glmm_duskAcousticSpaceUse.png", width=12, height=7, device = png(), units="in", dpi = 300);dev.off()
```


We now run generalized linear mixed models (GLMM) assuming gaussian errors and using log link functions to examine the effects of habitat (vegetation structure) on acoustic space use.

```{r}
# overall space use
glmm_allVeg<- glmer(totSpaceuse ~ PC1 + PC2 + (1|siteCode) + (1|visit), data = modelDataAll, family = gaussian(link="log"))

summary(glmm_allVeg)

# There is a significant effect of PC1 on acoustic space use

# dawn chorus
glmm_dawnVeg<- glmer(totSpaceuse ~ PC1 + PC2 + (1|siteCode) + (1|visit), data = modelDataDawn, family = gaussian(link="log"))

summary(glmm_dawnVeg)

# There is a significant effect of PC1 on dawn acoustic space use and a highly significant effect of PC2 on dawn acoustic space use

# dawn chorus
glmm_duskVeg<- glmer(totSpaceuse ~ PC1 + PC2 + (1|siteCode) + (1|visit), data = modelDataDusk, family = gaussian(link="log"))

summary(glmm_duskVeg)

# There is a significant effect of PC1 on dusk acoustic space use
```

Lastly, we explore correlations and associations between bird species richness and acoustic space use
```{r}
# loading jacknife scores 
jackAll <- read.csv("data/jackAll.csv")
jackRainforest <- read.csv("data/jackRainforest.csv")
jackOpencountry <- read.csv("data/jackOpencountry.csv")

# Load a dataframe of average space use by site
siteWiseAsu <- read.csv("data/site-wise-asu.csv")

# add restoration type
siteWiseAsu <- left_join(siteWiseAsu, sites, by=c("Site"="Site.code"))

# Separate analysis: space use during certain times of day alone
# let's look only at dawn chorus to explore what the data looks like
dawn <- c("05:00-06:00","06:00-07:00","07:00-08:00","08:00-09:00",
          "09:00-10:00")
dawnChorusAvgAsu <- siteWiseAsu %>%
  filter(time_of_day %in% dawn)

# Separate analysis: space use during certain times of day alone
# let's look only at dusk chorus to explore what the data looks like
dusk <- c("16:00-17:00","17:00-18:00","18:00-19:00","19:00-20:00")
duskChorusAvgAsu <- siteWiseAsu %>%
  filter(time_of_day %in% dusk)

# Calculating total space use across all frequency bins and times of day: 128*24 for each site-day combination

avgSpaceUse <- siteWiseAsu %>%
  group_by(Site, Restoration.type) %>%
  summarise(totSpaceuse = sum(f.cont.sum)) %>%
  full_join(jackAll, by=c("Site","Restoration.type")) %>% 
  mutate ("roundjk" = round(jack1)) %>%
  mutate("roundSpaceUse" = round(totSpaceuse)) %>%
  add_column(year = vegData$plantingYear)

# dawn
dawnAvgSpaceUse <- dawnChorusAvgAsu %>%
  group_by(Site, Restoration.type) %>%
  summarise(totSpaceuse = sum(f.cont.sum)) %>%
  full_join(jackAll, by=c("Site","Restoration.type")) %>% 
  mutate ("roundjk" = round(jack1)) %>%
  mutate("roundSpaceUse" = round(totSpaceuse)) %>%
  add_column(year = vegData$plantingYear)

#dusk
duskAvgSpaceUse <- duskChorusAvgAsu %>%
  group_by(Site, Restoration.type) %>%
  summarise(totSpaceuse = sum(f.cont.sum)) %>%
  full_join(jackAll, by=c("Site","Restoration.type")) %>% 
  mutate ("roundjk" = round(jack1)) %>%
  mutate("roundSpaceUse" = round(totSpaceuse)) %>%
  add_column(year = vegData$plantingYear)

# running generalized linear models
glmRichnessSpace <- glm(roundSpaceUse ~ roundjk, data = avgSpaceUse, family = poisson(link = log))
summary(glmRichnessSpace)

plot_model(glmRichnessSpace, type="pred")
report::report(glmRichnessSpace)

# The results suggest a significant and negative association between overall space use and first-order jacknife scores.
```

Let's look at year since restoration and ask if space use has a significant association with time
```{r}
allRestored <- avgSpaceUse %>%
  filter(Restoration.type=="Active") %>%
  mutate(yearSinceRestoration = (2022-year))

dawnRestored <- dawnAvgSpaceUse %>%
    filter(Restoration.type=="Active") %>%
  mutate(yearSinceRestoration = (2022-year))

duskRestored <- duskAvgSpaceUse %>%
    filter(Restoration.type=="Active") %>%
  mutate(yearSinceRestoration = (2022-year))

glmAll <- glm(roundSpaceUse ~ yearSinceRestoration, data = allRestored, family = poisson(link = log))
summary(glmAll)

plot_model(glmAll, type="pred")
report::report(glmAll)

glmDawn <- glm(roundSpaceUse ~ yearSinceRestoration, data = dawnRestored, family = poisson(link = log))
summary(glmDawn)

plot_model(glmDawn, type="pred")
report::report(glmDawn)

glmDusk <- glm(roundSpaceUse ~ yearSinceRestoration, data = duskRestored, family = poisson(link = log))
summary(glmDusk)

plot_model(glmDusk, type="pred")
report::report(glmDusk)

# all three analysis report a statistically significant and negative association with year since restoration and spaceuse values

```


