---
editor_options: 
  chunk_output_type: console
---

# Generalized linear mixed modeling (acoustic space use and vegetation data)

In this script, we run generalized linear models to test the association between acoustic space use values and restoration type. In addition, we run generalized linear mixed models to test associations between acoustic space use and habitat (vegetation structure) using site-pair name (actively restored and naturally regenerating were specified to be paired) and repeat visits as random effects.  

Install required libraries
```{r}
library(tidyverse)
library(dplyr)
library(stringr)
library(vegan)
library(ggplot2)
library(scico)
library(psych)
library(rcompanion)
library(multcomp)
library(lme4)

# Source any custom/other internal functions necessary for analysis
source("code/01_internal-functions.R")
```

Load necessary data for statistical modeling
```{r}
# load list of sites
sites <- read.csv("data/list-of-sites.csv") %>%     dplyr::select("Site.code","Restoration.type")

# load the entire asu data across all sites and days computed
sitebyDayAsu <- read.csv("data/site-by-day-asu.csv") 

# separate by Site and Date
sitebyDayAsu <- separate(sitebyDayAsu, col = Site_Day, into = c("Site", "Date"), sep = "_") 

# Add restoration type column to the space use data
sitebyDayAsu <- left_join(sitebyDayAsu, sites, by=c("Site"="Site.code"))

# scale values per site/date for comparison between sites and treatment types
sitebyDayAsu <- sitebyDayAsu %>%
  group_by(Site, Date, Restoration.type) %>%
  mutate(f.cont.scaled = range01(f.cont))

# computing total number of days for which space use has been computed for each site (some sites have very few days. Eg. OLV110R)
nSites_Days <- sitebyDayAsu %>%
  dplyr::select(Site, Date, Restoration.type) %>%
  distinct() %>% arrange(Site) %>% count(Site)

# Unique date site combination to give you a sense of sampling
# This suggests that we have a lot more data for benchmark sites
nDays_siteType <- sitebyDayAsu %>%
  dplyr::select(Site, Date, Restoration.type) %>%
  distinct() %>% arrange(Site) %>% count(Restoration.type)

# Separate analysis: space use during certain times of day alone
# let's look only at dawn chorus to explore what the data looks like
dawn <- c("05:00-06:00","06:00-07:00","07:00-08:00","08:00-09:00",
          "09:00-10:00")
dawnChorusAsu <- sitebyDayAsu %>%
  filter(time_of_day %in% dawn)

# Separate analysis: space use during certain times of day alone
# let's look only at dusk chorus to explore what the data looks like
dusk <- c("16:00-17:00","17:00-18:00","18:00-19:00","19:00-20:00")
duskChorusAsu <- sitebyDayAsu %>%
  filter(time_of_day %in% dusk)

# Prepare data for statistical modeling
# Calculating total space use across all frequency bins and times of day: 128*24 for each site-day combination

totSpaceUse <- sitebyDayAsu %>%
  group_by(Site, Date, Restoration.type) %>%
  summarise(totSpaceuse = sum(f.cont.scaled)) %>%
  group_by(Site) %>% 
  mutate(visit = row_number()) %>%
  mutate(siteCode = str_extract(Site, pattern = "\\w+\\d+")) %>%
  mutate(siteCode = factor(siteCode))

# Calculating total space use for dawn chorus alone for each site-day combination

totSpaceUseDawn <- dawnChorusAsu %>%
  group_by(Site, Date, Restoration.type) %>%
  summarise(totSpaceuse = sum(f.cont.scaled)) %>% 
  group_by(Site) %>% 
  mutate(visit = row_number()) %>%
  mutate(siteCode = str_extract(Site, pattern = "\\w+\\d+")) %>%
  mutate(siteCode = factor(siteCode))

# Calculating total space use for dusk chorus alone for each site-date combination

totSpaceUseDusk <- duskChorusAsu %>%
  group_by(Site, Date, Restoration.type) %>%
  summarise(totSpaceuse = sum(f.cont.scaled)) %>% 
  group_by(Site) %>% 
  mutate(visit = row_number()) %>%
  mutate(siteCode = str_extract(Site, pattern = "\\w+\\d+")) %>%
  mutate(siteCode = factor(siteCode))

# Load data from previous scripts for use in a GLM
vegData <-  read.csv("data/summaryVeg.csv") %>%
  filter(!str_detect(Site_ID, 'OLCAP5B'))
vegPcaScores <- read.csv("data/pcaVeg.csv") %>%
  filter(!str_detect(Site_ID, 'OLCAP5B'))
```


Getting data ready in a format for linear modeling
```{r}
# overall space use
modelDataAll <- vegPcaScores %>% 
  rename(Site = Site_ID) %>%
  rename(Restoration.type = Site_type) %>%
  mutate(across(Restoration.type, factor))  %>%
  full_join(totSpaceUse, by=c("Site","Restoration.type")) %>%
  mutate("roundSpaceuse" = round(totSpaceuse))

# dawn chorus space use
modelDataDawn <- vegPcaScores %>% 
  rename(Site = Site_ID) %>%
  rename(Restoration.type = Site_type) %>%
  mutate(across(Restoration.type, factor))  %>%
  full_join(totSpaceUseDawn, by=c("Site","Restoration.type")) %>%
  mutate("roundSpaceuse" = round(totSpaceuse))

# dusk chorus space use
modelDataDusk <- vegPcaScores %>% 
  rename(Site = Site_ID) %>%
  rename(Restoration.type = Site_type) %>%
  mutate(across(Restoration.type, factor))  %>%
  full_join(totSpaceUseDusk, by=c("Site","Restoration.type")) %>%
  mutate("roundSpaceuse" = round(totSpaceuse))
```

Running the generalized linear models

We now run generalized linear mixed models (GLM) assuming gaussian errors and using log link functions to examine the effects of restoration type (benchmark, actively restored and passively restored) on acoustic space use, followed by TukeyHSD multiple comparisons tests of means. 

```{r}
# overall space use
glmm_allRestoration <- glmer(roundSpaceuse ~ Restoration.type + (1|siteCode) + (1|visit), data = modelDataAll, family = gaussian)

summary(glmm_allRestoration)
tukey_glmmAllRestoration <- summary(glht(glmm_allRestoration, linfct=mcp(Restoration.type ="Tukey")))
cld(tukey_glmmAllRestoration)

anova(glm_totSpaceUse, test = 'Chisq')
nagelkerke(glm_totSpaceUse)
tukey_glmtotSpaceUse <- summary(glht(glm_totSpaceUse, mcp(Restoration.type = "Tukey")))
cld(tukey_glmtotSpaceUse)

# The above result suggests a significant difference in acoustic space use values for benchmark sites and passively restored sites and benchmark sites and actively restored sites (but no difference between active-passive)

# dawn chorus
glm_dawnSpaceUse <- glm(spaceUse ~ Restoration.type, data = modelDataDawn, family = gaussian)
summary(glm_dawnSpaceUse)

anova(glm_dawnSpaceUse, test = 'Chisq')
nagelkerke(glm_dawnSpaceUse)
tukey_glmDawnSpaceUse <- summary(glht(glm_dawnSpaceUse, mcp(Restoration.type = "Tukey")))
cld(tukey_glmDawnSpaceUse)

# The above result suggests no significant difference in acoustic space use values across treatment types

# dawn chorus
glm_duskSpaceUse <- glm(spaceUse ~ Restoration.type, data = modelDataDusk, family = gaussian)
summary(glm_duskSpaceUse)

anova(glm_duskSpaceUse, test = 'Chisq')
nagelkerke(glm_duskSpaceUse)
tukey_glmDuskSpaceUse <- summary(glht(glm_duskSpaceUse, mcp(Restoration.type = "Tukey")))
cld(tukey_glmDuskSpaceUse)

# The above result suggests a significant difference in acoustic space use values for benchmark sites and passively restored sites and benchmark sites and actively restored sites (but no difference between active-passive)
```

Running generalized linear mixed models

Testing the role of habitat (vegetation structure) and on acoustic space use within a generalized linear modeling framework

```{r}
# all bird species
glmm_totSpaceUse <- glmer(spaceUse ~ PC1 + PC2 + (1|siteCode), data = modelDataAll, family = gaussian)
summary(glmm_totSpaceUse)
```


