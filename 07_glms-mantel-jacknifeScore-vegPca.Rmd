---
editor_options: 
  chunk_output_type: console
---

# Generalized linear models and Mantel's tests

Install required libraries
```{r}
library(tidyverse)
library(dplyr)
library(stringr)
library(vegan)
library(ggplot2)
library(scico)
library(psych)

# Source any custom/other internal functions necessary for analysis
source("code/01_internal-functions.R")
```


Load the necessary data for statistical modeling
```{r}
# We load the subset data
datSubset <- read.csv("data/datSubset.csv")

# Load species-trait data to essentially check for associations by habitat type
trait_dat <- read.csv("data/species-trait-dat.csv")

# Total number of detections
totalDetections <- datSubset %>%
  group_by(Site, Restoration.Type) %>%
  transform() %>% replace(is.na(.), 0) %>%
  summarise_at(.vars = vars(c("IP":"CR")),.funs = sum) %>%
  summarise(totalDetections = sum(c_across("IP":"CR")))

# richness
richness <- datSubset %>%
  group_by(Site, Restoration.Type) %>%
  transform() %>% replace(is.na(.), 0) %>%
  summarise_at(.vars = vars(c("IP":"CR")),.funs = sum) %>% 
  mutate_at(vars(c("IP":"CR")),~ replace(., . > 0, 1)) %>%
  rowwise() %>% 
  mutate(richness = sum(c_across(IP:CR))) %>%
  dplyr::select(Site, Restoration.Type, richness)

# number of visits per site
nVisits <- datSubset %>%
  dplyr::select(Site, Date)%>%
  distinct() %>% arrange(Site) %>% count(Site) %>%
  rename(., nVisits=n)

# summary data
# We further estimate the number of detections per point count
datSummary <- totalDetections %>%
  left_join(richness) %>%
  left_join(nVisits) %>%
  mutate(pointDetections = totalDetections/nVisits)

# combine the nDetections dataframe with the trait dataset
nDetectionsTrait <- datSubset %>%
  group_by(Site, Restoration.Type, Date) %>%
  transform() %>% replace(is.na(.), 0) %>%
  summarise_at(.vars = vars(c("IP":"CR")),.funs = sum) %>%
  pivot_longer(cols=IP:CR, names_to="Species_Code", values_to="count") %>%
  left_join(.,trait_dat, by=c("Species_Code"="species_annotation_codes")) %>%
  dplyr::select(-c(scientific_name)) %>%
  mutate(forRichness = case_when(count>0 ~ 1,count==0 ~ 0)) %>%
  rename(., nDetections = count)

# Load data from previous scripts for use in a GLM
vegData <-  read.csv("data/summaryVeg.csv")
vegPcaScores <- read.csv("data/pcaVeg.csv")
jackAll <- read.csv("data/jackAll.csv")
jackRainforest <- read.csv("data/jackRainforest.csv")
jackOpencountry <- read.csv("data/jackOpencountry.csv")
```

Getting data ready in a format for generalized linear modeling
```{r}
# All birds
modelDataAll <- vegPcaScores %>% 
  add_column (Site = vegData$Site_ID,
              Restoration.Type = as.factor(datSummary$Restoration.Type),
              jackknife = jackAll$jack1,
              nSpecies = jackAll$Species,
              totalDetections = datSummary$totalDetections,
              pointDetections = datSummary$pointDetections, 
              plantingYear = vegData$plantingYear) %>% 
  mutate ("roundjk" = round(jackknife))

# rainforest birds
modelData_rainForest <- vegPcaScores %>% 
  add_column (Site = vegData$Site_ID,
              Restoration.Type = as.factor(datSummary$Restoration.Type),
              jackknife = jackRainforest$jack1,
              nSpecies =  jackRainforest$Species,
              plantingYear = vegData$plantingYear) %>% 
  mutate ("roundjk" = round(jackknife))

# open country birds
modelData_openCountry <- vegPcaScores %>% 
  add_column (Site = vegData$Site_ID,
              Restoration.Type = as.factor(datSummary$Restoration.Type),
              jackknife = jackOpencountry$jack1,
              nSpecies =  jackOpencountry$Species,
              plantingYear = vegData$plantingYear) %>% 
  mutate ("roundjk" = round(jackknife))


```


