---
editor_options: 
  chunk_output_type: console
---

# Generalized linear modeling (acoustic space use and richness, and time since restoration)

In this script, we run generalized linear models to test the association between acoustic space use values and species richness, vocal activity (total calling rate at each site, which is a proxy for the total number of vocal detections/unit of recording time) and time since restoration. 

Install required libraries
```{r}
library(tidyverse)
library(dplyr)
library(stringr)
library(vegan)
library(ggplot2)
library(scico)
library(psych)
library(rcompanion)
library(multcomp)
library(lme4)
library(ggpubr)
library(sjPlot)

# Source any custom/other internal functions necessary for analysis
source("code/01_internal-functions.R")
```

Load necessary data for statistical modeling
```{r}
# load list of sites
sites <- read.csv("data/list-of-sites.csv") %>% 
  dplyr::select("Site.code","Restoration.type") %>%
  filter(Site.code != "OLCAP5B")

# loading jacknife scores 
jackAll <- read.csv("data/jackAll.csv")
jack_rainForest <- read.csv("data/jackRainforest.csv")
jack_openCountry <- read.csv("data/jackOpencountry.csv")

# Load vegetation data from previous scripts 
vegData <-  read.csv("data/summaryVeg.csv") %>%
  filter(!str_detect(Site_ID, 'OLCAP5B'))
vegPcaScores <- read.csv("data/pcaVeg.csv") %>%
  filter(!str_detect(Site_ID, 'OLCAP5B'))

# Attach the annotation data
datSubset <- read.csv("data/datSubset.csv")

# Calculate the overall number of detections for each site where each temporal duration chosen is a 10s clip
nDetections <- datSubset %>%
  group_by(Site, Restoration.type) %>%
  transform() %>% replace(is.na(.), 0) %>% 
  summarise_at(.vars = vars(c("IP":"HSWP")),.funs = sum) 

# total number of detections at each site
totDetections <-  nDetections %>%
   rowwise() %>% 
   summarise(totDetections = sum(c_across(IP:HSWP)))

# Load a dataframe of average space use by site
siteWiseAsu <- read.csv("data/site-wise-asu.csv")

# add restoration type
siteWiseAsu <- left_join(siteWiseAsu, sites, by=c("Site"="Site.code"))

# Separate analysis: space use during certain times of day alone
# let's look only at dawn chorus to explore what the data looks like
dawn <- c("05:00-06:00","06:00-07:00","07:00-08:00","08:00-09:00",
          "09:00-10:00")
dawnChorusAvgAsu <- siteWiseAsu %>%
  filter(time_of_day %in% dawn)

# Separate analysis: space use during certain times of day alone
# let's look only at dusk chorus to explore what the data looks like
dusk <- c("16:00-17:00","17:00-18:00","18:00-19:00","19:00-20:00")
duskChorusAvgAsu <- siteWiseAsu %>%
  filter(time_of_day %in% dusk)

# Calculating total space use across all frequency bins and times of day: 128*24 for each site-day combination

avgSpaceUse <- siteWiseAsu %>%
  group_by(Site, Restoration.type) %>%
  summarise(totSpaceuse = sum(f.cont.sum)) %>%
  full_join(jackAll, by=c("Site","Restoration.type")) %>% 
  mutate ("roundjk" = round(jack1)) %>%
  mutate("roundSpaceUse" = round(totSpaceuse)) %>%
  add_column(year = vegData$plantingYear) %>%
  add_column(totDetections = totDetections$totDetections)

# dawn
dawnAvgSpaceUse <- dawnChorusAvgAsu %>%
  group_by(Site, Restoration.type) %>%
  summarise(totSpaceuse = sum(f.cont.sum)) %>%
  full_join(jackAll, by=c("Site","Restoration.type")) %>% 
  mutate ("roundjk" = round(jack1)) %>%
  mutate("roundSpaceUse" = round(totSpaceuse)) %>%
  add_column(year = vegData$plantingYear) %>%
  add_column(totDetections = totDetections$totDetections)

#dusk
duskAvgSpaceUse <- duskChorusAvgAsu %>%
  group_by(Site, Restoration.type) %>%
  summarise(totSpaceuse = sum(f.cont.sum)) %>%
  full_join(jackAll, by=c("Site","Restoration.type")) %>% 
  mutate ("roundjk" = round(jack1)) %>%
  mutate("roundSpaceUse" = round(totSpaceuse)) %>%
  add_column(year = vegData$plantingYear) %>%
  add_column(totDetections = totDetections$totDetections)

```

Let's first explore richness (as measured through first order jacknife scores and test for associations with space use)
```{r}
# running generalized linear models
glmRichnessSpace <- glm(roundSpaceUse ~ roundjk, data = avgSpaceUse, family = poisson(link = log))
summary(glmRichnessSpace)

plot_model(glmRichnessSpace, type="pred")
report::report(glmRichnessSpace)

# The results suggest a significant and negative association between overall space use and first-order jacknife scores

# creating separate dataframes to test for associations with rainforest species and open country species

avgSpaceUseRain <- siteWiseAsu %>%
  group_by(Site, Restoration.type) %>%
  summarise(totSpaceuse = sum(f.cont.sum)) %>%
  full_join(jack_rainForest, by=c("Site","Restoration.type")) %>% 
  mutate ("roundjk" = round(jack1)) %>%
  mutate("roundSpaceUse" = round(totSpaceuse)) %>%
  add_column(year = vegData$plantingYear) %>%
  add_column(totDetections = totDetections$totDetections)

avgSpaceUseOpen <- siteWiseAsu %>%
  group_by(Site, Restoration.type) %>%
  summarise(totSpaceuse = sum(f.cont.sum)) %>%
  full_join(jack_openCountry, by=c("Site","Restoration.type")) %>% 
  mutate ("roundjk" = round(jack1)) %>%
  mutate("roundSpaceUse" = round(totSpaceuse)) %>%
  add_column(year = vegData$plantingYear) %>%
  add_column(totDetections = totDetections$totDetections)

# Rainforest species
glmRichnessRain <- glm(roundSpaceUse ~ roundjk, data = avgSpaceUseRain, family = poisson(link = log))
summary(glmRichnessRain)

plot_model(glmRichnessRain, type="pred")
report::report(glmRichnessRain)

# for rainforest species,  The effect of roundjk is statistically significant and positive (beta = 0.01, 95% CI [0.01, 0.02], p < .001; Std. beta = 0.09, 95% CI [0.08, 0.11])

# open country species
glmRichnessOpen <- glm(roundSpaceUse ~ roundjk, data = avgSpaceUseOpen, family = poisson(link = log))
summary(glmRichnessOpen)

plot_model(glmRichnessOpen, type="pred")
report::report(glmRichnessOpen)

# For open country birds, The effect of roundjk is statistically significant and negative (beta = -0.04, 95% CI [-0.04, -0.04], p < .001; Std. beta = -0.24, 95% CI [-0.26, -0.22])
```


Let's look at year since restoration and ask if space use has a significant association with time
```{r}
allRestored <- avgSpaceUse %>%
  filter(Restoration.type=="Active") %>%
  mutate(yearSinceRestoration = (2022-year))

dawnRestored <- dawnAvgSpaceUse %>%
    filter(Restoration.type=="Active") %>%
  mutate(yearSinceRestoration = (2022-year))

duskRestored <- duskAvgSpaceUse %>%
    filter(Restoration.type=="Active") %>%
  mutate(yearSinceRestoration = (2022-year))

glmAll <- glm(roundSpaceUse ~ yearSinceRestoration, data = allRestored, family = poisson(link = log))
summary(glmAll)

plot_model(glmAll, type="pred")
report::report(glmAll)

glmDawn <- glm(roundSpaceUse ~ yearSinceRestoration, data = dawnRestored, family = poisson(link = log))
summary(glmDawn)

plot_model(glmDawn, type="pred")
report::report(glmDawn)

glmDusk <- glm(roundSpaceUse ~ yearSinceRestoration, data = duskRestored, family = poisson(link = log))
summary(glmDusk)

plot_model(glmDusk, type="pred")
report::report(glmDusk)

# all three analysis report a statistically significant and negative association with year since restoration and spaceuse values

```

Let's look at associations between acoustic space use and sum total of detections of species at each site
```{r}
glmDetections<- glm(roundSpaceUse ~ totDetections, data = avgSpaceUse, family = poisson(link = log))
summary(glmDetections)

plot_model(glmDetections, type="pred")
report::report(glmDetections)

# The effect of totDetections is statistically significant and positive (beta = 7.93e-05, 95% CI [5.19e-05, 1.07e-04], p < .001; Std. beta = 0.05, 95% CI [0.03, 0.07])

# # What if we look at it by habitat affiliation
# rainforest species and open country species

glmRainDet <- glm(roundSpaceUse ~ totDetections, data = avgSpaceUseRain, family = poisson(link = log))
summary(glmRainDet)

plot_model(glmRainDet, type="pred")
report::report(glmRainDet)

# For rainforest birds, The effect of totDetections is statistically significant and positive (beta = 7.93e-05, 95% CI [5.19e-05, 1.07e-04], p < .001; Std. beta = 0.05, 95% CI [0.03, 0.07])

glmOpenDet <- glm(roundSpaceUse ~ totDetections, data = avgSpaceUseOpen, family = poisson(link = log))
summary(glmOpenDet)

plot_model(glmOpenDet, type="pred")
report::report(glmOpenDet)

# For open country birds, The effect of totDetections is statistically significant and positive (beta = 7.93e-05, 95% CI [5.19e-05, 1.07e-04], p < .001; Std. beta = 0.05, 95% CI [0.03, 0.07])
```



