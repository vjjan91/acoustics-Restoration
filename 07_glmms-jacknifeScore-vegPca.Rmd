---
editor_options: 
  chunk_output_type: console
---

# Generalized linear mixed modeling (species richness and vegetation data)

In this script, we run generalized linear models to test the association between first order jacknife scores and restoration type. In addition, we run generalized linear mixed models to test associations between species richness and habitat (vegetation structure) using site-pair name (actively restored and naturally regenerating were specified to be paired) and repeat visits as random effects.  

Install required libraries
```{r}
library(tidyverse)
library(dplyr)
library(stringr)
library(vegan)
library(ggplot2)
library(scico)
library(psych)
library(rcompanion)
library(multcomp)
library(lme4)

# Source any custom/other internal functions necessary for analysis
source("code/01_internal-functions.R")
```


Load the necessary data for statistical modeling
```{r}
# We load the subset data
datSubset <- read.csv("data/datSubset.csv")

# Load species-trait data to essentially check for associations by habitat type
trait_dat <- read.csv("data/species-trait-dat.csv")

# Total number of detections
totalDetections <- datSubset %>%
  group_by(Site, Restoration.Type) %>%
  transform() %>% replace(is.na(.), 0) %>%
  summarise_at(.vars = vars(c("IP":"CR")),.funs = sum) %>%
  summarise(totalDetections = sum(c_across("IP":"CR")))

# richness
richness <- datSubset %>%
  group_by(Site, Restoration.Type) %>%
  transform() %>% replace(is.na(.), 0) %>%
  summarise_at(.vars = vars(c("IP":"CR")),.funs = sum) %>% 
  mutate_at(vars(c("IP":"CR")),~ replace(., . > 0, 1)) %>%
  rowwise() %>% 
  mutate(richness = sum(c_across(IP:CR))) %>%
  dplyr::select(Site, Restoration.Type, richness)

# richness by Visit
# this data basically gives you richness per visit and adds a visit number for each consecutive visit to that site
richnessPerVisit <- datSubset %>%
  group_by(Site, Date, Restoration.Type) %>%
  transform() %>% replace(is.na(.), 0) %>%
  summarise_at(.vars = vars(c("IP":"CR")),.funs = sum) %>% 
  mutate_at(vars(c("IP":"CR")),~ replace(., . > 0, 1)) %>%
  rowwise() %>% 
  mutate(richness = sum(c_across(IP:CR))) %>%
  group_by(Site) %>% 
  mutate(visit = row_number()) %>%
  mutate(siteCode = str_extract(Site, pattern = "\\w+\\d+")) %>%
  mutate(siteCode = factor(siteCode)) %>%
  dplyr::select(Site, Restoration.Type, Date, richness, visit, siteCode)

# We further estimate the number of detections per point count
datSummary <- totalDetections %>%
  left_join(richness) %>%
  mutate(pointDetections = totalDetections/3)

# combine the Detections dataframe with the trait dataset
nDetectionsTrait <- datSubset %>%
  group_by(Site, Restoration.Type, Date) %>%
  transform() %>% replace(is.na(.), 0) %>%
  summarise_at(.vars = vars(c("IP":"CR")),.funs = sum) %>%
  pivot_longer(cols=IP:CR, names_to="Species_Code", values_to="count") %>%
  left_join(.,trait_dat, by=c("Species_Code"="species_annotation_codes")) %>%
  mutate(forRichness = case_when(count>0 ~ 1,count==0 ~ 0)) %>%
  rename(., nDetections = count)

# Load data from previous scripts for use in a GLM
vegData <-  read.csv("data/summaryVeg.csv")
vegPcaScores <- read.csv("data/pcaVeg.csv")
jackAll <- read.csv("data/jackAll.csv")
jackRainforest <- read.csv("data/jackRainforest.csv")
jackOpencountry <- read.csv("data/jackOpencountry.csv")
```


Getting data ready in a format for generalized linear modeling
```{r}
# All birds
modelDataAll <- vegPcaScores %>% 
  add_column (Site = vegData$Site_ID,
              Restoration.Type = as.factor(datSummary$Restoration.Type),
              jackknife = jackAll$jack1,
              nSpecies = jackAll$Species,
              totalDetections = datSummary$totalDetections,
              pointDetections = datSummary$pointDetections, 
              plantingYear = vegData$plantingYear) %>% 
  mutate ("roundjk" = round(jackknife))

# rainforest birds
modelData_rainForest <- vegPcaScores %>% 
  add_column (Site = vegData$Site_ID,
              Restoration.Type = as.factor(datSummary$Restoration.Type),
              jackknife = jackRainforest$jack1,
              nSpecies =  jackRainforest$Species,
              plantingYear = vegData$plantingYear) %>% 
  mutate ("roundjk" = round(jackknife))

# open country birds
modelData_openCountry <- vegPcaScores %>% 
  add_column (Site = vegData$Site_ID,
              Restoration.Type = as.factor(datSummary$Restoration.Type),
              jackknife = jackOpencountry$jack1,
              nSpecies =  jackOpencountry$Species,
              plantingYear = vegData$plantingYear) %>% 
  mutate ("roundjk" = round(jackknife))
```

Getting data ready for generalized linear mixed modeling
```{r}
# data for the GLMM
glmmAll <- richnessPerVisit[,-2] %>%
  full_join(modelDataAll, by = "Site")

# rainforest birds
glmmRainforest <- nDetectionsTrait %>%
  group_by(Site, Restoration.Type, Date) %>% 
  filter (Habitat == "RF") %>%
  summarise(richness = sum(forRichness)) %>%
  group_by(Site) %>% 
  mutate(visit = row_number()) %>%
  mutate(siteCode = str_extract(Site, pattern = "\\w+\\d+")) %>%
  mutate(siteCode = factor(siteCode)) %>%
  select(-Restoration.Type) %>%
  full_join(modelData_rainForest, by="Site")
  
# open-country birds
glmmOpencountry <- nDetectionsTrait %>%
  group_by(Site, Restoration.Type, Date) %>% 
  filter (Habitat == "OC") %>%
  summarise(richness = sum(forRichness)) %>%
  group_by(Site) %>% 
  mutate(visit = row_number()) %>%
  mutate(siteCode = str_extract(Site, pattern = "\\w+\\d+")) %>%
  mutate(siteCode = factor(siteCode)) %>%
  select(-Restoration.Type) %>%
  full_join(modelData_openCountry, by="Site")

# Let's look at species by foraging habit
# canopy birds
glmmCanopy <- nDetectionsTrait %>%
  group_by(Site, Restoration.Type, Date) %>% 
  filter (Habit == "CAN") %>%
  summarise(richness = sum(forRichness)) %>%
  group_by(Site) %>% 
  mutate(visit = row_number()) %>%
  mutate(siteCode = str_extract(Site, pattern = "\\w+\\d+")) %>%
  mutate(siteCode = factor(siteCode)) %>%
  select(-Restoration.Type) %>%
  full_join(modelDataAll, by="Site")
  
# ground-feeding birds
glmmGround <- nDetectionsTrait %>%
  group_by(Site, Restoration.Type, Date) %>% 
  filter (Habit == "GRD") %>%
  summarise(richness = sum(forRichness)) %>%
  group_by(Site) %>% 
  mutate(visit = row_number()) %>%
  mutate(siteCode = str_extract(Site, pattern = "\\w+\\d+")) %>%
  mutate(siteCode = factor(siteCode)) %>%
  select(-Restoration.Type) %>%
  full_join(modelDataAll, by="Site")

# mid-storey birds
glmmMidStorey <- nDetectionsTrait %>%
  group_by(Site, Restoration.Type, Date) %>% 
  filter (Habit == "MID") %>%
  summarise(richness = sum(forRichness)) %>%
  group_by(Site) %>% 
  mutate(visit = row_number()) %>%
  mutate(siteCode = str_extract(Site, pattern = "\\w+\\d+")) %>%
  mutate(siteCode = factor(siteCode)) %>%
  select(-Restoration.Type) %>%
  full_join(modelDataAll, by="Site")

# understorey birds
glmmUnderStory <- nDetectionsTrait %>%
  group_by(Site, Restoration.Type, Date) %>% 
  filter (Habit == "UND") %>%
  summarise(richness = sum(forRichness)) %>%
  group_by(Site) %>% 
  mutate(visit = row_number()) %>%
  mutate(siteCode = str_extract(Site, pattern = "\\w+\\d+")) %>%
  mutate(siteCode = factor(siteCode)) %>%
  select(-Restoration.Type) %>%
  full_join(modelDataAll, by="Site")

```


Running the generalized linear models

We now run generalized linear models (GLM) assuming Poisson errors and using log link functions to examine the effects of restoration type (benchmark, actively restored and passively restored) on the jackknife estimates of bird species richness (for all, rainforest, and open-country species), followed by TukeyHSD multiple comparisons tests of means. For each model, we carried out chi-square tests of significance, and calculated Nagelkerke pseudo-R2 measure of goodness of fit.
```{r}
# all birds
glm_allBirds <- glm(roundjk ~ Restoration.Type, data = modelDataAll, family = poisson(link = log))
summary(glm_allBirds)

anova(glm_allBirds, test = 'Chisq')
nagelkerke(glm_allBirds)
tukey_glmAllBirds <- summary(glht(glm_allBirds, mcp(Restoration.Type = "Tukey")))
cld(tukey_glmAllBirds)

# The above result suggests a significant difference in first order jacknife estimates for benchmark sites and passively restored site (but no difference between active-passive and active-benchmark).

# rainforest birds
glm_rainForest <- glm(roundjk ~ Restoration.Type, data = modelData_rainForest, family = poisson(link = log))
summary(glm_rainForest)

anova(glm_rainForest, test = 'Chisq')
nagelkerke(glm_rainForest)

tukey_glmRainforest <- summary(glht(glm_rainForest, mcp(Restoration.Type = "Tukey")))
cld(tukey_glmRainforest)

# The above result suggests a significant difference in first order jacknife estimates of rainforest species between benchmark and active sites. 

# open country birds
glm_openCountry <- glm(roundjk ~ Restoration.Type, data = modelData_openCountry, family = poisson(link = log))
summary(glm_openCountry)

anova(glm_openCountry, test = 'Chisq')
nagelkerke(glm_openCountry)

tukey_glmOpenCountry <- summary(glht(glm_openCountry, mcp(Restoration.Type = "Tukey")))
cld(tukey_glmOpenCountry)

# For open country birds, there is a significant difference in first-order jacknife estimates for both benchmark and active sites and benchmark and passively restored sites. 

```


Running generalized linear mixed models

Testing the role of habitat (vegetation structure) and foraging habit on species richness within a generalized linear modeling framework
```{r}
# Testing the role of habitat first

# all bird species
glmm_allBirds <- glmer(richness ~ PC1 + PC2 + (1|siteCode) + (1|visit), data = glmmAll, family = poisson(link = log))
summary(glmm_allBirds)

# rainforest birds
glmm_Rainforest <- glmer(richness ~ PC1 + PC2 + (1|siteCode) + (1|visit), data = glmmRainforest, family = poisson(link = log))
summary(glmm_Rainforest)

# Results above suggest PC1 is significantly negatively associated with richness of rainforest birds. A similar result is seen below for open-country bird species richness and PC1

glmm_openCountry <- glmer(richness ~ PC1 + PC2 + (1|siteCode) + (1|visit), data = glmmOpencountry, family = poisson(link = log))
summary(glmm_openCountry)

# Testing the role of foraging habit

# canopy birds (no significant association)
glmm_Canopy <- glmer(richness ~ PC1 + PC2 + (1|siteCode) + (1|visit), data = glmmCanopy, family = poisson(link = log))
summary(glmm_Canopy)

# ground-feeding birds (Marginal association between richness of ground-feeding birds and PC2)
glmm_Ground <- glmer(richness ~ PC1 + PC2 + (1|siteCode) + (1|visit), data = glmmGround, family = poisson(link = log))
summary(glmm_Ground)

# mid-storey birds (Marginal association between PC1 and richness of mid-storey birds)
glmm_MidStorey <- glmer(richness ~ PC1 + PC2 + (1|siteCode) + (1|visit), data = glmmMidStorey, family = poisson(link = log))
summary(glmm_MidStorey)

# understory birds (no significant association)
glmm_Understory <- glmer(richness ~ PC1 + PC2 + (1|siteCode) + (1|visit), data = glmmUnderStory, family = poisson(link = log))
summary(glmm_Understory)

```


